<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Neural Living - V6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --cyan: #06b6d4; --bg: #050508; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .font-futuristic { font-family: 'Orbitron', sans-serif; }
        .glass-panel { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #network-container { width: 100vw; height: 100vh; background: radial-gradient(circle at center, #0d112d 0%, #050508 100%); }
        
        #floating-plus {
            position: absolute; display: none; width: 32px; height: 32px;
            background: var(--cyan); border-radius: 50%; color: black;
            text-align: center; line-height: 32px; font-weight: bold;
            cursor: pointer; z-index: 100; box-shadow: 0 0 20px var(--cyan);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Hiệu ứng nhấp nháy cho Spaced Repetition */
        @keyframes pulse-spaced {
            0% { box-shadow: 0 0 0px #f43f5e; }
            50% { box-shadow: 0 0 25px #f43f5e; }
            100% { box-shadow: 0 0 0px #f43f5e; }
        }
    </style>
</head>
<body>

    <div class="fixed top-6 left-8 z-50 pointer-events-none">
        <h1 class="font-futuristic text-2xl text-cyan-400 tracking-tighter uppercase">Neural_Living_V6</h1>
        <p class="text-[9px] text-gray-500 uppercase tracking-[0.4em]">Sức sống vật lý: 100% | Cảm nhận liên kết: Active</p>
    </div>

    <div id="floating-plus">+</div>

    <div class="fixed top-24 left-8 z-50 w-60 glass-panel rounded-2xl p-5 border-l-2 border-cyan-500 shadow-2xl">
        <div id="node-list" class="max-h-[30vh] overflow-y-auto space-y-1 text-[11px] mb-4 pr-2"></div>
        <button onclick="activateAddNodeMode()" class="w-full py-3 bg-cyan-600/10 border border-cyan-500/30 rounded-xl text-[9px] text-cyan-400 hover:bg-cyan-600 hover:text-white transition uppercase font-bold tracking-widest">
            + THÊM THỰC THỂ [N]
        </button>
    </div>

    <div id="data-panel" class="fixed top-0 right-0 h-full w-96 glass-panel z-[100] transform translate-x-full transition-transform duration-500 p-8 border-l border-cyan-500/20">
        <button onclick="closePanel()" class="text-gray-500 hover:text-white text-[10px] mb-8 uppercase font-futuristic">[ Close ]</button>
        <div id="panel-body"></div>
    </div>

    <div id="system-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-md">
        <div id="modal-box" class="glass-panel w-96 p-8 rounded-3xl border border-cyan-500/30 transform scale-95 transition-all">
            <h3 id="modal-title" class="font-futuristic text-cyan-400 text-xs mb-4 tracking-widest uppercase">Input Data</h3>
            <input type="text" id="modal-input" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-cyan-500 mb-6">
            <div class="flex gap-4">
                <button onclick="closeModal()" class="flex-1 py-3 rounded-xl border border-white/10 text-gray-400 text-[10px] font-bold uppercase">Hủy</button>
                <button id="modal-confirm" class="flex-1 py-3 rounded-xl bg-cyan-600 text-black text-[10px] font-bold uppercase">Xác nhận</button>
            </div>
        </div>
    </div>

    <div id="network-container"></div>

    <script>
        // --- DATA HUB ---
        let nodes = new vis.DataSet(JSON.parse(localStorage.getItem('brain_v6_nodes')) || [{ id: 1, label: 'CORE', color: '#06b6d4', level: 3, lastUpdate: Date.now() }]);
        let edges = new vis.DataSet(JSON.parse(localStorage.getItem('brain_v6_edges')) || []);
        let selectedNodeId = null;
        let isAddNodeMode = false;

        const container = document.getElementById('network-container');
        const plusButton = document.getElementById('floating-plus');

        // --- CẤU HÌNH VẬT LÝ SIÊU LINH ĐỘNG ---
        const options = {
            nodes: {
                shape: 'dot',
                font: { color: '#ffffff', size: 14, face: 'Inter' },
                borderWidth: 2,
                shadow: { enabled: true, color: 'rgba(6, 182, 212, 0.2)', size: 10 }
            },
            edges: {
                color: { color: 'rgba(6, 182, 212, 0.2)', highlight: '#06b6d4' },
                arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                smooth: { type: 'continuous', forceDirection: 'none' },
                width: 1.5
            },
            physics: {
                enabled: true,
                barnesHut: {
                    gravitationalConstant: -4000, // Tăng lực đẩy để các nút nhúc nhích xa nhau
                    centralGravity: 0.2, // Lực hút về tâm nhẹ để tạo độ nhún
                    springLength: 200, // Độ dài lò xo
                    springConstant: 0.05, // Độ cứng lò xo (càng thấp càng nhún nhảy)
                    damping: 0.09 // Độ mượt của chuyển động
                },
                stabilization: { iterations: 100, updateInterval: 25 },
                adaptiveTimestep: true // Tự điều chỉnh tốc độ mượt mà
            },
            interaction: {
                hover: true,
                tooltipDelay: 200,
                hideEdgesOnDrag: false // Giữ dây khi kéo để thấy độ nhún
            }
        };

        const network = new vis.Network(container, { nodes, edges }, options);

        // --- THUẬT TOÁN "CẢM NHẬN" LIÊN KẾT ---
        function updateNodeCognition() {
            const allNodes = nodes.get();
            const updateArray = allNodes.map(node => {
                const connectedEdges = edges.get({ filter: e => e.from === node.id || e.to === node.id });
                const noteLength = (node.note || "").length;
                
                // Thuật toán: Nút càng nhiều liên kết và ghi chú càng dài thì càng to và sáng
                const baseSize = 15;
                const newSize = baseSize + (connectedEdges.length * 3) + (noteLength / 100);
                
                return { 
                    id: node.id, 
                    size: Math.min(newSize, 50),
                    font: { size: 12 + (connectedEdges.length) }
                };
            });
            nodes.update(updateArray);
        }

        // --- LOGIC TƯƠNG TÁC ---
        network.on("click", function(params) {
            if (isAddNodeMode && params.nodes.length === 0) {
                const canvasPos = params.pointer.canvas;
                isAddNodeMode = false;
                container.style.cursor = 'default';
                showPrompt("Đặt tên thực thể", (label) => {
                    const newId = Date.now();
                    nodes.add({ id: newId, label, color: '#94a3b8', level: 1, lastUpdate: Date.now(), x: canvasPos.x, y: canvasPos.y });
                    saveData();
                    updateNodeCognition();
                });
                return;
            }

            if (params.nodes.length > 0) {
                selectedNodeId = params.nodes[0];
                const pos = params.pointer.DOM;
                plusButton.style.left = (pos.x + 25) + 'px';
                plusButton.style.top = (pos.y - 25) + 'px';
                plusButton.style.display = 'block';
                openPanelById(selectedNodeId);
                
                // Hiệu ứng "Rung động" mạng lưới khi click
                network.startSimulation(); 
            } else {
                plusButton.style.display = 'none';
                closePanel();
            }
        });

        // --- SINH NHÁNH (Linh động thuật toán) ---
        plusButton.onclick = () => {
            showPrompt("Sinh nhánh mới", (label) => {
                const newId = Date.now();
                nodes.add({ id: newId, label, color: '#94a3b8', level: 1, lastUpdate: Date.now() });
                edges.add({ from: selectedNodeId, to: newId });
                saveData();
                updateNodeCognition();
                teleport(newId);
            });
        };

        // --- TRUY XUẤT CÁCH QUÃNG (Spaced Repetition) ---
        function runSpacedRepetition() {
            const now = Date.now();
            const weekMs = 7 * 24 * 60 * 60 * 1000;
            nodes.update(nodes.get().map(node => ({
                id: node.id,
                borderWidth: (now - (node.lastUpdate || 0) > weekMs) ? 4 : 2,
                shadow: { enabled: true, color: (now - (node.lastUpdate || 0) > weekMs) ? '#f43f5e' : 'rgba(6, 182, 212, 0.2)', size: 20 }
            })));
        }

        // --- UI UTILS ---
        function openPanelById(id) {
            const node = nodes.get(id);
            document.getElementById('data-panel').classList.remove('translate-x-full');
            document.getElementById('panel-body').innerHTML = `
                <h2 class="text-xl font-bold text-cyan-400 font-futuristic mb-4 uppercase tracking-tighter">${node.label}</h2>
                <textarea id="node-note" class="w-full h-72 bg-black/40 border border-white/10 rounded-2xl p-5 text-xs text-gray-300 focus:outline-none focus:border-cyan-500 leading-relaxed">${node.note || ''}</textarea>
                <button onclick="updateNote(${id})" class="w-full py-4 mt-6 bg-cyan-600/20 border border-cyan-500/30 text-cyan-400 text-[10px] font-bold rounded-xl uppercase tracking-widest hover:bg-cyan-600 transition">Đồng bộ bộ nhớ</button>
            `;
        }

        function updateNote(id) {
            nodes.update({ id, note: document.getElementById('node-note').value, lastUpdate: Date.now() });
            saveData();
            updateNodeCognition();
        }

        function saveData() { localStorage.setItem('brain_v6_nodes', JSON.stringify(nodes.get())); localStorage.setItem('brain_v6_edges', JSON.stringify(edges.get())); }
        function teleport(id) { network.focus(id, { scale: 1.2, animation: true }); network.selectNodes([id]); openPanelById(id); }
        function focusCenter() { network.fit({animation:true}); }
        function closeModal() { document.getElementById('system-modal').classList.add('hidden'); }
        function closePanel() { document.getElementById('data-panel').classList.add('translate-x-full'); }
        function activateAddNodeMode() { isAddNodeMode = true; container.style.cursor = 'crosshair'; }
        
        function showPrompt(title, callback) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('system-modal').classList.remove('hidden');
            const input = document.getElementById('modal-input');
            input.value = '';
            setTimeout(() => input.focus(), 100);
            document.getElementById('modal-confirm').onclick = () => { if(input.value) { closeModal(); callback(input.value); } };
        }

        network.on("doubleClick", (p) => {
            if (p.nodes.length > 0) {
                const id = p.nodes[0];
                const node = nodes.get(id);
                let nextLevel = (node.level || 1) + 1;
                if (nextLevel > 3) nextLevel = 1;
                const colors = { 1: '#94a3b8', 2: '#eab308', 3: '#22c55e' };
                nodes.update({ id, level: nextLevel, color: colors[nextLevel], lastUpdate: Date.now() });
                saveData();
            }
        });

        nodes.on('*', () => {
            document.getElementById('node-list').innerHTML = nodes.get().map(n => `<div onclick="teleport(${n.id})" class="p-2 cursor-pointer hover:bg-white/5 rounded-lg flex items-center truncate transition-all"><span class="w-1.5 h-1.5 rounded-full mr-3" style="background:${n.color}"></span>${n.label}</div>`).join('');
        });

        setInterval(runSpacedRepetition, 60000);
        updateNodeCognition();

        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'n') activateAddNodeMode();
            if (e.code === 'Space' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); focusCenter(); }
        });
    </script>
</body>
</html>
