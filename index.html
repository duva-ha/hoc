<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Neural Sync - V29 Chronos Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --cyan: #06b6d4; --bg: #050508; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .font-futuristic { font-family: 'Orbitron', sans-serif; }
        .glass-panel { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #network-container { width: 100vw; height: 100vh; background: radial-gradient(circle at center, #0d112d 0%, #050508 100%); }
        .zoom-wrapper { position: fixed; right: 30px; top: 50%; transform: translateY(-50%); z-index: 100; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .vertical-slider { -webkit-appearance: none; width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; outline: none; transform: rotate(-90deg); cursor: pointer; }
        .vertical-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 15px; height: 15px; border-radius: 50%; background: var(--cyan); box-shadow: 0 0 10px var(--cyan); border: none; }
        #floating-plus { position: absolute; display: none; width: 35px; height: 35px; background: var(--cyan); border-radius: 50%; color: black; text-align: center; line-height: 35px; font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 0 20px var(--cyan); }
        .vis-label { white-space: pre !important; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--cyan); cursor: pointer; }
    </style>
</head>
<body>

    <div class="fixed top-6 left-8 z-50 pointer-events-none">
        <h1 class="font-futuristic text-2xl text-cyan-400 tracking-tighter uppercase">Neural_Fixed_V29</h1>
        <div id="sync-status" class="text-[8px] text-gray-500 uppercase tracking-widest flex items-center gap-2">
            <span id="sync-dot" class="w-1.5 h-1.5 bg-green-500 rounded-full animate-ping"></span> 
            <span id="sync-text">Cloud Sync: Ready</span>
        </div>
    </div>

    <div id="floating-plus">+</div>

    <div class="fixed top-24 left-8 z-50 w-64 glass-panel rounded-2xl p-6 border-l-2 border-cyan-500 shadow-2xl">
        <button onclick="toggleQuizMode()" id="quiz-btn" class="w-full py-3 mb-4 bg-white/5 border border-white/10 rounded-xl text-[9px] text-gray-400 hover:text-white transition uppercase font-bold flex items-center justify-center gap-2">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/></svg>
            Quiz [Q]
        </button>
        <input type="text" id="search-input" oninput="neuralSearch()" placeholder="Tìm tên..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-[10px] text-cyan-400 focus:outline-none mb-4">
        <div id="node-list" class="max-h-[30vh] overflow-y-auto space-y-1 text-[11px] pr-2"></div>
        <button onclick="activateAddNodeMode()" class="w-full mt-4 py-3 bg-cyan-600/10 border border-cyan-500/30 rounded-xl text-[9px] text-cyan-400 hover:bg-cyan-600 transition font-bold uppercase">+ Thêm [N]</button>
    </div>

    <div class="zoom-wrapper glass-panel py-6 px-2 rounded-full border border-white/5">
        <input type="range" id="zoom-slider" class="vertical-slider" min="0.1" max="3" step="0.1" value="1">
    </div>

    <div class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[150] w-[75%] glass-panel p-6 rounded-[2.5rem] border border-white/10 shadow-2xl">
        <div class="flex items-center gap-4">
            <button onclick="togglePlay()" class="w-12 h-12 flex items-center justify-center bg-cyan-500/10 border border-cyan-500/30 rounded-full text-cyan-400">
                <svg id="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            </button>
            <select id="time-unit" class="bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-[9px] text-cyan-400 font-futuristic focus:outline-none">
                <option value="1">1s = Thực tế</option>
                <option value="86400000">1s = Ngày</option>
                <option value="604800000">1s = Tuần</option>
            </select>
            <div class="flex-1 px-4">
                <input type="range" id="time-slider" oninput="travelTime()" class="w-full h-1 bg-white/5 rounded-lg appearance-none cursor-pointer outline-none" min="0" max="100" value="100">
                <div class="flex justify-between mt-2">
                    <span id="time-display" class="text-[10px] text-cyan-400 font-mono font-bold uppercase mx-auto">LIVE</span>
                </div>
            </div>
        </div>
    </div>

    <div id="system-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-md">
        <div id="modal-box" class="glass-panel w-96 p-8 rounded-3xl border border-cyan-500/30 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-red-500 transition-colors"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h3 class="font-futuristic text-cyan-400 text-[10px] mb-6 uppercase text-center tracking-widest">Tạo Neuron</h3>
            <input type="text" id="modal-input" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-4 text-sm text-white focus:outline-none focus:border-cyan-500 mb-6" placeholder="Nhập tên...">
            <button id="modal-confirm" class="w-full py-4 rounded-xl bg-cyan-600 text-black text-[10px] font-bold uppercase tracking-widest">Xác nhận</button>
        </div>
    </div>

    <div id="network-container"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmTIcdk8mpNY9gp4Cg9AoZsvrByMtTc3Q",
            authDomain: "qlhs-app.firebaseapp.com",
            projectId: "qlhs-app",
            storageBucket: "qlhs-app.firebasestorage.app",
            messagingSenderId: "24933893013",
            appId: "1:24933893013:web:db6deb6ea2a80ca244ec9c",
            databaseURL: "https://qlhs-app-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let isQuizMode = false, isAddNodeMode = false, isPlaying = false, playInterval = null;
        const colorsCycle = ['#06b6d4', '#22c55e', '#eab308', '#f97316', '#a855f7', '#f43f5e'];

        const network = new vis.Network(document.getElementById('network-container'), { nodes, edges }, {
            nodes: { shape: 'dot', font: { color: '#ffffff', face: 'Inter', size: 14, multi: true }, borderWidth: 2, shadow: true },
            edges: { color: 'rgba(6, 182, 212, 0.2)', arrows: 'to', smooth: true, dashes: true },
            physics: { enabled: true, barnesHut: { gravitationalConstant: -5000, centralGravity: 0.1, springLength: 200 } }
        });

        function saveData() {
            const data = {
                nodes: nodes.get().map(n => { const { x, y, ...rest } = n; return JSON.parse(JSON.stringify(rest)); }),
                edges: edges.get().map(e => JSON.parse(JSON.stringify(e))),
                updateAt: Date.now()
            };
            db.ref('neural_brain').set(data);
        }

        function loadData() {
            db.ref('neural_brain').on('value', (snap) => {
                const val = snap.val();
                if(val && val.nodes) {
                    nodes.update(val.nodes);
                    if(val.edges) edges.update(val.edges);
                    updateLabels();
                } else if(nodes.length === 0) {
                    nodes.add({ id: Date.now(), label: 'GIVISO CORE', originalLabel: 'GIVISO CORE', color: colorsCycle[0], colorIndex: 0 });
                }
            });
        }

        // --- CHRONOS FIXED LOGIC ---
        function travelTime() {
            const slider = document.getElementById('time-slider');
            const all = nodes.get(); if (all.length === 0) return;
            const start = Math.min(...all.map(n => n.id));
            const currentPoint = start + (parseFloat(slider.value) / 100) * (Date.now() - start);
            
            document.getElementById('time-display').innerText = slider.value == 100 ? "LIVE" : new Date(currentPoint).toLocaleDateString('vi-VN');
            
            nodes.update(all.map(n => ({ id: n.id, hidden: n.id > currentPoint })));
            edges.update(edges.get().map(e => ({ id: e.id, hidden: nodes.get(e.from).id > currentPoint || nodes.get(e.to).id > currentPoint })));
            if(!isPlaying) network.startSimulation();
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const icon = document.getElementById('play-icon');
            const slider = document.getElementById('time-slider');
            
            if (isPlaying) {
                if (parseFloat(slider.value) >= 100) slider.value = 0;
                icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                
                const unitValue = parseInt(document.getElementById('time-unit').value);
                const all = nodes.get();
                const start = Math.min(...all.map(n => n.id));
                const totalSpan = Date.now() - start;

                playInterval = setInterval(() => {
                    let step = (unitValue === 1) ? (1000 / totalSpan * 100) : ((unitValue / 10) / totalSpan * 100);
                    let newVal = parseFloat(slider.value) + step;
                    
                    if (newVal < 100) {
                        slider.value = newVal;
                        travelTime();
                    } else {
                        slider.value = 100;
                        travelTime();
                        togglePlay();
                    }
                }, 100);
            } else {
                icon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
                clearInterval(playInterval);
            }
        }

        // --- DELETE & OTHER TOOLS ---
        function deleteNode() {
            const selected = network.getSelectedNodes();
            if (selected.length > 0) {
                const nodeLabel = nodes.get(selected[0]).originalLabel;
                if(confirm(`Xóa thực thể: ${nodeLabel}?`)) { nodes.remove(selected[0]); saveData(); }
            }
        }

        network.on("doubleClick", (p) => {
            if(p.nodes.length > 0) {
                const id = p.nodes[0]; const n = nodes.get(id);
                let idx = ((n.colorIndex || 0) + 1) % colorsCycle.length;
                nodes.update({ id, color: colorsCycle[idx], colorIndex: idx });
                saveData();
            }
        });

        function activateAddNodeMode() { isAddNodeMode = true; document.getElementById('network-container').style.cursor = 'crosshair'; }
        network.on("click", (p) => {
            if (isAddNodeMode && p.nodes.length === 0) {
                showModal((l) => { nodes.add({id:Date.now(), label:l, originalLabel:l, color:colorsCycle[0], colorIndex:0, x:p.pointer.canvas.x, y:p.pointer.canvas.y}); saveData(); updateLabels(); });
                isAddNodeMode = false; document.getElementById('network-container').style.cursor = 'default';
            }
            if (p.nodes.length > 0) {
                window.selId = p.nodes[0];
                document.getElementById('floating-plus').style.cssText = `display:block;left:${p.pointer.DOM.x+30}px;top:${p.pointer.DOM.y-30}px;`;
            } else document.getElementById('floating-plus').style.display = 'none';
        });

        document.getElementById('floating-plus').onclick = () => {
            showModal((l) => { const nid=Date.now(); nodes.add({id:nid, label:l, originalLabel:l, color:colorsCycle[0], colorIndex:0}); edges.add({from:window.selId, to:nid}); saveData(); updateLabels(); });
        };

        function showModal(cb) { document.getElementById('system-modal').classList.remove('hidden'); const i = document.getElementById('modal-input'); i.value = ''; setTimeout(()=>i.focus(),100); document.getElementById('modal-confirm').onclick = () => { if(!i.value) return; closeModal(); cb(i.value); }; }
        function closeModal() { document.getElementById('system-modal').classList.add('hidden'); }
        function neuralSearch() { const q = document.getElementById('search-input').value.toLowerCase(); nodes.update(nodes.get().map(n => ({ id: n.id, opacity: n.originalLabel.toLowerCase().includes(q) ? 1 : 0.1 }))); }
        function toggleQuizMode() { isQuizMode = !isQuizMode; document.getElementById('quiz-btn').classList.toggle('bg-red-500/20'); updateLabels(); }
        function updateLabels() { nodes.update(nodes.get().map(n => ({ id: n.id, label: isQuizMode ? "?" : n.originalLabel }))); }

        document.getElementById('zoom-slider').oninput = function() { network.moveTo({ scale: parseFloat(this.value) }); };
        
        window.addEventListener('keydown', (e) => { 
            if(e.key === 'Delete' || e.key === 'Backspace') deleteNode();
            if(e.key.toLowerCase()==='q') toggleQuizMode(); 
            if(e.key.toLowerCase()==='n') activateAddNodeMode();
            if(e.key === 'Escape') closeModal();
            if(e.code==='Space') { e.preventDefault(); network.fit({animation:true}); }
        });

        loadData();
    </script>
</body>
</html>
